% After identifying a task as likely non-terminating, \sys must decide when during the task's execution to partially commit the task's state. \sys sets a timer at the start of the likely non-terminating task, initializing it to a very large value (e.g., an estimate of the maximum execution time using the device's energy buffer). If the timer expires before power fails, \sys partially commits, retaining  the timer value to use for future partial commits. If the timer does not expire before power fails, \sys halves the timer and tries again. The exponential decrease of the timer value converges rapidly to a usable one.

\subsection{Task Downscaling}
\label{sec:task_downsizing}

\sys uses {\em task downscaling} to make progress through a task that is too large to complete using the energy that the device can buffer. Task downscaling executes part of the long task and interrupts its execution with a {\em partial commit}, after which the long task continues. This timer-based solution is similar to the one proposed in~\cite{ratchet}. If power fails, the partial commit preserves the progress through the task, and execution resumes from the point of the partial commit, rather than from the start of the task. Eventually, after some number of partial commits and power failures, the task will complete and execution will proceed. Task downscaling violates task atomicity in a non-terminating execution, favoring continued progress over atomicity. If a programmer requires a task's atomicity to be preserved, they can disable task downscaling for that task. The key design issue for task downscaling is deciding when to partially commit. A task is likely to be non-terminating if it fails to run to completion twice consecutively. The second incomplete run executes after a power failure, when the device will have fully recharged its energy buffer. If a task cannot complete when executing with a full energy buffer, \sys marks the task as non-terminating.